name: Supabase Monthly Backup

on:
  # ë§¤ì›” 1ì¼ ì˜¤ì „ 2ì‹œ (UTC) ì‹¤í–‰
  schedule:
    - cron: '0 2 1 * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ì‹¤ì œ ë°±ì—… ì—†ì´ ë¡œê·¸ë§Œ ì¶œë ¥)'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18'
  BACKUP_RETENTION_DAYS: 60  # 2ê°œì›”ê°„ ë³´ê´€

jobs:
  backup:
    name: Supabase Database Backup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          npm ci
          npm install @supabase/supabase-js
          
      - name: Create backup directory
        run: mkdir -p backups
        
      - name: Run Supabase backup
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ì‹¤ì œ ë°±ì—…ì„ ìˆ˜í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo "í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
            echo "SUPABASE_URL: ${SUPABASE_URL:+ì„¤ì •ë¨}"
            echo "SUPABASE_ACCESS_TOKEN: ${SUPABASE_ACCESS_TOKEN:+ì„¤ì •ë¨}"
            echo "SUPABASE_PROJECT_ID: ${SUPABASE_PROJECT_ID:+ì„¤ì •ë¨}"
            exit 0
          fi
          
          node scripts/backup-supabase.js
          
      - name: Upload backup artifacts
        if: github.event.inputs.test_mode != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-${{ github.run_number }}
          path: backups/
          retention-days: ${{ env.BACKUP_RETENTION_DAYS }}
          
      - name: Create GitHub Release (for monthly backups)
        if: github.event_name == 'schedule' && github.event.inputs.test_mode != 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: backup-${{ github.run_number }}
          name: Monthly Supabase Backup - ${{ github.run_number }}
          body: |
            ## ğŸ“¦ ìˆ˜íŒŒë² ì´ìŠ¤ ì›”ê°„ ë°±ì—…
            
            **ë°±ì—… ì¼ì‹œ:** ${{ github.run_number }}
            **ì›Œí¬í”Œë¡œìš° ì‹¤í–‰:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ### ğŸ“‹ ë°±ì—… ë‚´ìš©
            - ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ (DDL)
            - ëª¨ë“  í…Œì´ë¸” ë°ì´í„° (INSERT ë¬¸)
            - ì••ì¶•ëœ ë°±ì—… íŒŒì¼
            
            ### ğŸ”§ ë³µì› ë°©ë²•
            ```bash
            # ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ í›„
            unzip supabase-backup-*.zip
            # ìŠ¤í‚¤ë§ˆ ë³µì›
            psql -f schema-*.sql
            # ë°ì´í„° ë³µì›  
            psql -f data-*.sql
            ```
            
            ### âš ï¸ ì£¼ì˜ì‚¬í•­
            - ì´ ë°±ì—…ì€ í”„ë¡œë•ì…˜ í™˜ê²½ ë³µì›ìš©ì…ë‹ˆë‹¤
            - ë³µì› ì „ ë°˜ë“œì‹œ í˜„ì¬ ë°ì´í„°ë¥¼ ë°±ì—…í•˜ì„¸ìš”
            - í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ë¨¼ì € ê²€ì¦í•˜ì„¸ìš”
          files: backups/*
          draft: false
          prerelease: false
          
      - name: Send notification (on failure)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#alerts'
          text: |
            ğŸš¨ ìˆ˜íŒŒë² ì´ìŠ¤ ë°±ì—… ì‹¤íŒ¨
            
            **í”„ë¡œì íŠ¸:** ${{ github.repository }}
            **ì›Œí¬í”Œë¡œìš°:** ${{ github.workflow }}
            **ì‹¤í–‰ ID:** ${{ github.run_id }}
            **ë¡œê·¸:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: Send success notification
        if: success() && github.event_name == 'schedule'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#backups'
          text: |
            âœ… ìˆ˜íŒŒë² ì´ìŠ¤ ì›”ê°„ ë°±ì—… ì™„ë£Œ
            
            **í”„ë¡œì íŠ¸:** ${{ github.repository }}
            **ë°±ì—… íƒœê·¸:** backup-${{ github.run_number }}
            **ë¦´ë¦¬ìŠ¤:** ${{ github.server_url }}/${{ github.repository }}/releases/tag/backup-${{ github.run_number }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
